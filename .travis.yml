language: objective-c
osx_image: xcode7.3
env:
  global:
    - CONFIG=opt
    - TEST=objc
    - JOBS=1
  matrix:
    - TEST_PATH="src/objective-c/tests" WORKSPACE="Tests.xcworkspace"
      SCHEME="RxLibraryUnitTests" BUILD_ONLY="false" INTEROP_SERVER="false"
    - TEST_PATH="src/objective-c/tests" WORKSPACE="Tests.xcworkspace"
      SCHEME="InteropTestsLocalSSL" BUILD_ONLY="false" INTEROP_SERVER="true"
    - TEST_PATH="src/objective-c/tests" WORKSPACE="Tests.xcworkspace"
      SCHEME="InteropTestsLocalCleartext" BUILD_ONLY="false"
      INTEROP_SERVER="true"
    # TODO(jcanizales): Investigate why they time out:
    # - TEST_PATH="src/objective-c/tests" WORKSPACE="Tests.xcworkspace"
    #   SCHEME="InteropTestsRemote" BUILD_ONLY=false INTEROP_SERVER=true
    - TEST_PATH="examples/objective-c/helloworld"
      WORKSPACE="HelloWorld.xcworkspace" SCHEME="HelloWorld" BUILD_ONLY="true"
      INTEROP_SERVER="false"
    - TEST_PATH="examples/objective-c/route_guide"
      WORKSPACE="RouteGuideClient.xcworkspace" SCHEME="RouteGuideClient"
      BUILD_ONLY="true" INTEROP_SERVER="false"
    - TEST_PATH="examples/objective-c/auth_sample"
      WORKSPACE="AuthSample.xcworkspace" SCHEME="AuthSample" BUILD_ONLY="true"
      INTEROP_SERVER="false"
    - TEST_PATH="src/objective-c/examples/Sample" WORKSPACE="Sample.xcworkspace"
      SCHEME="Sample" BUILD_ONLY="true" INTEROP_SERVER="false"
    - TEST_PATH="src/objective-c/examples/SwiftSample"
      WORKSPACE="SwiftSample.xcworkspace" SCHEME="SwiftSample" BUILD_ONLY="true"
      INTEROP_SERVER="false"
before_install:
  - pod --version
  - gem uninstall cocoapods -a
  - gem install cocoapods -v '1.0.0'
  - pod --version
  - brew install gflags
  - pushd third_party/protobuf
  - git checkout v3.0.0-beta-3
  - popd
install:
  - make grpc_objective_c_plugin
  - install bins/opt/grpc_objective_c_plugin /usr/local/bin/protoc-gen-objcgrpc
  - install bins/opt/protobuf/protoc /usr/local/bin/protoc
  - pushd $TEST_PATH
  - pod install
  - popd
before_script:
  - if [ "${INTEROP_SERVER}" = "true" ]; then
      make interop_server;
      (bins/$CONFIG/interop_server --port=5050 &);
      (bins/$CONFIG/interop_server --port=5051 --use_tls &);
    fi
script:
  - if [ "${BUILD_ONLY}" = "true" ]; then
      xctool -workspace "$TEST_PATH/$WORKSPACE" -scheme "$SCHEME"
      -sdk iphonesimulator9.3 clean build;
    else
      xctool -workspace "$TEST_PATH/$WORKSPACE" -scheme "$SCHEME"
      -sdk iphonesimulator9.3 build test;
    fi
notifications:
  email: false
